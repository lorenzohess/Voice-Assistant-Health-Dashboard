{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>Health Overview</h1>
    
    <div class="header-controls">
        <div class="control-buttons">
            <button class="btn btn-icon" onclick="clearDisplayData()" title="Clear Display">
                üóëÔ∏è
            </button>
            <button class="btn btn-icon" onclick="loadSampleData()" title="Load Sample Data">
                üìä
            </button>
        </div>
        
        <div class="time-window-selector">
            <a href="?window=1w" class="time-btn {% if window == '1w' %}active{% endif %}">1W</a>
            <a href="?window=1m" class="time-btn {% if window == '1m' %}active{% endif %}">1M</a>
            <a href="?window=3m" class="time-btn {% if window == '3m' %}active{% endif %}">3M</a>
            <a href="?window=6m" class="time-btn {% if window == '6m' %}active{% endif %}">6M</a>
            <a href="?window=1y" class="time-btn {% if window == '1y' %}active{% endif %}">1Y</a>
        </div>
    </div>
</div>

<div class="dashboard-layout">
<div class="dashboard-main">
<div class="dashboard-grid">
    <!-- Weight Card -->
    <div class="card">
        <div class="card-header">
            <h2>Weight</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('weightModal')">+ Add</button>
        </div>
        <div class="chart-container" id="weightChart"></div>
        <div class="metrics-row">
            <span class="metric-inline"><b>{{ weight_metrics.latest or 'N/A' }}</b>{% if weight_metrics.latest %} lbs{% endif %}</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">avg {{ weight_metrics.average or 'N/A' }}</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">med {{ weight_metrics.median or 'N/A' }}</span>
        </div>
        <div class="voice-hint">"I weigh N lbs"</div>
    </div>
    
    <!-- Sleep Card -->
    <div class="card">
        <div class="card-header">
            <h2>Sleep</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('sleepModal')">+ Add</button>
        </div>
        <div class="chart-container" id="sleepChart"></div>
        <div class="metrics-row">
            <span class="metric-inline"><b>{{ sleep_metrics.latest or 'N/A' }}</b>{% if sleep_metrics.latest %} hrs{% endif %}</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">avg {{ sleep_metrics.average or 'N/A' }}</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">med {{ sleep_metrics.median or 'N/A' }}</span>
        </div>
        <div class="voice-hint">"I slept N hours"</div>
    </div>
    
    <!-- Wake Time Card -->
    <div class="card">
        <div class="card-header">
            <h2>Wake Time</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('wakeModal')">+ Add</button>
        </div>
        <div class="chart-container" id="wakeChart"></div>
        <div class="metrics-row">
            <span class="metric-inline"><b>{{ wake_metrics.latest_formatted }}</b></span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">{{ wake_metrics.count }} entries</span>
        </div>
        <div class="voice-hint">"I woke up at N AM"</div>
    </div>
    
    <!-- Workout Card -->
    <div class="card">
        <div class="card-header">
            <h2>Workouts</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('workoutModal')">+ Add</button>
        </div>
        <div class="chart-container" id="workoutChart"></div>
        <div class="metrics-row">
            <span class="metric-inline"><b>{{ workout_metrics.total }}</b> total</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">{{ workout_metrics.days_with_workout }} days active</span>
        </div>
        <div class="voice-hint">"I worked out for N minutes"</div>
    </div>
    
    <!-- Calories Card -->
    <div class="card">
        <div class="card-header">
            <h2>Calories</h2>
            <div class="card-header-actions">
                <button class="btn btn-secondary btn-sm" onclick="openModal('presetModal')">Presets</button>
                <button class="btn btn-primary btn-sm" onclick="openModal('calorieModal')">+ Add</button>
            </div>
        </div>
        <div class="chart-container" id="calorieChart"></div>
        <div class="metrics-row">
            <span class="metric-inline {% if today_calories > 2500 %}warning{% endif %}"><b>{{ today_calories|int }}</b> kcal</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">avg {{ calorie_metrics.average or 'N/A' }}</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">{{ food_count }} foods</span>
        </div>
        <div class="voice-hint">"Add N calories"</div>
        
        {# Today's Meals - commented out for now
        {% if today_entries %}
        <div class="today-meals">
            <h4>Today's Meals</h4>
            <div class="meal-list">
                {% for entry in today_entries %}
                <div class="meal-item" data-id="{{ entry.id }}">
                    <div class="meal-info">
                        <span class="meal-name">{{ entry.meal_name }}</span>
                        <span class="meal-cals">{{ entry.calories|int }} kcal</span>
                    </div>
                    <button class="btn-icon delete-meal" onclick="deleteCalorieEntry({{ entry.id }})" title="Delete">√ó</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        #}
        
        {# Quick Add Preset - commented out for now
        <div class="quick-presets">
            <h4>Quick Add Preset</h4>
            <div class="preset-search-container">
                <input type="text" id="presetSearchInput" class="preset-search-input" placeholder="Search presets..." autocomplete="off">
                <div class="preset-dropdown" id="presetDropdown">
                    {% for preset in presets %}
                    <div class="preset-dropdown-item" data-id="{{ preset.id }}" data-name="{{ preset.name|lower }}" data-category="{{ (preset.category or '')|lower }}">
                        <span class="preset-dropdown-name">{{ preset.name }}</span>
                        <span class="preset-dropdown-cal">{{ preset.calories|int }} kcal</span>
                    </div>
                    {% else %}
                    <div class="preset-dropdown-empty">No presets yet</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        #}
    </div>
    
    <!-- Custom Metric Cards -->
    {% for cm in custom_charts %}
    <div class="card custom-metric-card" data-metric-id="{{ cm.id }}">
        <div class="card-header">
            <h2>{{ cm.name }}</h2>
            <div class="card-actions">
                <button class="btn btn-primary btn-sm" onclick="openAddCustomEntryModal({{ cm.id }}, '{{ cm.name }}', '{{ cm.unit }}')">+ Add</button>
                <button class="btn btn-secondary btn-sm" onclick="openEditMetricModal({{ cm.id }}, '{{ cm.name }}', '{{ cm.unit }}', '{{ cm.color }}', '{{ cm.voice_keyword or '' }}')" title="Edit metric">‚úé</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomMetric({{ cm.id }}, '{{ cm.name }}')">√ó</button>
            </div>
        </div>
        <div class="chart" id="custom-chart-{{ cm.id }}"></div>
        <div class="metrics-row">
            <span class="metric-inline"><b>{{ "%.1f"|format(cm.metrics.latest) if cm.metrics.latest is not none else "‚Äî" }}</b> {{ cm.unit }}</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">avg {{ "%.1f"|format(cm.metrics.average) if cm.metrics.average is not none else "‚Äî" }}</span>
            <span class="metric-sep">¬∑</span>
            <span class="metric-inline">{{ cm.metrics.count }} entries</span>
        </div>
        {% if cm.voice_keyword %}
        <div class="voice-hint">"{{ cm.voice_keyword|capitalize }} N {{ cm.unit }}"</div>
        {% endif %}
    </div>
    {% endfor %}

    <!-- Add New Metric Card -->
    <div class="card add-metric-card" onclick="openModal('addMetricModal')">
        <div class="add-metric-content">
            <div class="add-icon">+</div>
            <span>Add New Graph</span>
        </div>
    </div>
</div><!-- end dashboard-grid -->
</div><!-- end dashboard-main -->

<!-- Right Sidebar -->
<aside class="dashboard-sidebar">
    <!-- Date & Time Panel -->
    <div class="sidebar-panel datetime-panel">
        <div class="day-of-week" id="dayOfWeek"></div>
        <div class="date-iso" id="dateIso"></div>
        <div class="time-clock" id="timeClock"></div>
    </div>
    
    <!-- Volume Control -->
    <div class="sidebar-panel volume-panel">
        <div class="volume-header">
            <span class="volume-icon" id="volumeIcon">üîä</span>
            <span class="volume-label">Volume</span>
            <span class="volume-value" id="volumeValue">65%</span>
        </div>
        <div class="volume-controls">
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="65" oninput="updateVolume(this.value)">
            <button class="mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute">üîá</button>
        </div>
    </div>
    
    <!-- Alarm Control -->
    <div class="sidebar-panel alarm-panel">
        <div class="alarm-header">
            <span class="alarm-icon">‚è∞</span>
            <span class="alarm-label">Alarm</span>
            <label class="alarm-toggle">
                <input type="checkbox" id="alarmEnabled" onchange="toggleAlarmEnabled()">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="alarm-time-row">
            <input type="time" id="alarmTime" value="08:00" onchange="updateAlarmTime()">
            <button class="alarm-stop-btn" id="alarmStopBtn" onclick="stopAlarm()" style="display: none;">Stop</button>
        </div>
        <div class="alarm-days" id="alarmDays">
            <label class="day-checkbox"><input type="checkbox" value="mon" checked> M</label>
            <label class="day-checkbox"><input type="checkbox" value="tue" checked> T</label>
            <label class="day-checkbox"><input type="checkbox" value="wed" checked> W</label>
            <label class="day-checkbox"><input type="checkbox" value="thu" checked> T</label>
            <label class="day-checkbox"><input type="checkbox" value="fri" checked> F</label>
            <label class="day-checkbox"><input type="checkbox" value="sat" checked> S</label>
            <label class="day-checkbox"><input type="checkbox" value="sun" checked> S</label>
        </div>
    </div>
    
    <!-- Pool Schedule -->
    <div class="sidebar-panel pool-panel">
        <div class="panel-header">
            <h3>Pool Schedule</h3>
            <button class="btn btn-link" onclick="openModal('poolScheduleModal')">Full</button>
        </div>
        
        <div class="pool-status">
            {% if pool_status.is_open %}
            <div class="pool-status-badge open">
                <span class="status-dot"></span>
                OPEN NOW
            </div>
            <p class="pool-closes">Closes at {{ pool_status.closes_at }}</p>
            {% elif pool_status.is_closed_today %}
            <div class="pool-status-badge closed">
                <span class="status-dot"></span>
                CLOSED TODAY
            </div>
            {% else %}
            <div class="pool-status-badge closed">
                <span class="status-dot"></span>
                CLOSED
            </div>
            {% endif %}
            
            {% if pool_status.exception_msg %}
            <p class="pool-exception">{{ pool_status.exception_msg }}</p>
            {% endif %}
        </div>
        
        {% if pool_status.sessions_today %}
        <div class="pool-today">
            <h4>{{ pool_status.day_name }}'s Sessions</h4>
            <div class="pool-sessions">
                {% for session in pool_status.sessions_today %}
                <span class="pool-session {{ session.status }}">{{ session.time }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if pool_status.next_session and not pool_status.is_open %}
        <div class="pool-next">
            <span class="next-label">Next session:</span>
            <span class="next-time">{{ pool_status.next_session.day_name }} {{ pool_status.next_session.session_str }}</span>
        </div>
        {% endif %}
    </div>
</aside>
</div><!-- end dashboard-layout -->

<!-- Add Custom Metric Modal -->
<div class="modal" id="addMetricModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Graph</h3>
            <button class="modal-close" onclick="closeModal('addMetricModal')">&times;</button>
        </div>
        <form id="addMetricForm" onsubmit="submitAddMetric(event)">
            <div class="form-group">
                <label for="metricName">Name</label>
                <input type="text" id="metricName" name="name" placeholder="e.g., Vegetable Servings" required>
            </div>
            <div class="form-group">
                <label for="metricUnit">Unit</label>
                <input type="text" id="metricUnit" name="unit" placeholder="e.g., servings, glasses, minutes" value="units">
            </div>
            <div class="form-group">
                <label for="metricChartType">Chart Type</label>
                <select id="metricChartType" name="chart_type">
                    <option value="bar">Bar Chart</option>
                    <option value="line">Line Chart</option>
                </select>
            </div>
            <div class="form-group">
                <label for="metricColor">Color</label>
                <input type="color" id="metricColor" name="color" value="#6366f1">
            </div>
            <div class="form-group">
                <label for="metricVoiceKeyword">Voice Keyword (optional)</label>
                <input type="text" id="metricVoiceKeyword" name="voice_keyword" placeholder="e.g., medication">
                <small class="form-hint">Say "keyword + number" to log via voice (e.g., "medication 2")</small>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Create Graph</button>
        </form>
    </div>
</div>

<!-- Edit Custom Metric Modal -->
<div class="modal" id="editMetricModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Graph</h3>
            <button class="modal-close" onclick="closeModal('editMetricModal')">&times;</button>
        </div>
        <form id="editMetricForm" onsubmit="submitEditMetric(event)">
            <input type="hidden" id="editMetricId" name="id">
            <div class="form-group">
                <label for="editMetricName">Name</label>
                <input type="text" id="editMetricName" name="name" required>
            </div>
            <div class="form-group">
                <label for="editMetricUnit">Unit</label>
                <input type="text" id="editMetricUnit" name="unit">
            </div>
            <div class="form-group">
                <label for="editMetricColor">Color</label>
                <input type="color" id="editMetricColor" name="color">
            </div>
            <div class="form-group">
                <label for="editMetricVoiceKeyword">Voice Keyword</label>
                <input type="text" id="editMetricVoiceKeyword" name="voice_keyword" placeholder="e.g., medication">
                <small class="form-hint">Say "keyword + number" to log via voice. Leave empty to disable.</small>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Save Changes</button>
        </form>
    </div>
</div>

<!-- Add Custom Entry Modal -->
<div class="modal" id="addCustomEntryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="addCustomEntryTitle">Add Entry</h3>
            <button class="modal-close" onclick="closeModal('addCustomEntryModal')">&times;</button>
        </div>
        <form id="addCustomEntryForm" onsubmit="submitAddCustomEntry(event)">
            <input type="hidden" id="customEntryMetricId" name="metric_id">
            <div class="form-group">
                <label for="customEntryDate">Date</label>
                <input type="date" id="customEntryDate" name="date" value="{{ today }}" required>
            </div>
            <div class="form-group">
                <label for="customEntryValue">Value (<span id="customEntryUnit">units</span>)</label>
                <input type="number" id="customEntryValue" name="value" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="customEntryNotes">Notes (optional)</label>
                <input type="text" id="customEntryNotes" name="notes" placeholder="Optional notes">
            </div>
            <button type="submit" class="btn btn-primary btn-block">Add Entry</button>
        </form>
    </div>
</div>

<!-- Pool Schedule Modal -->
<div class="modal" id="poolScheduleModal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3>Weekly Pool Schedule</h3>
            <button class="modal-close" onclick="closeModal('poolScheduleModal')">&times;</button>
        </div>
        <table class="pool-schedule-table">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Sessions</th>
                </tr>
            </thead>
            <tbody>
                {% for day in pool_weekly %}
                <tr>
                    <td>{{ day.day }}</td>
                    <td>{{ day.sessions }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Weight Modal -->
<div class="modal" id="weightModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Weight</h3>
            <button class="modal-close" onclick="closeModal('weightModal')">&times;</button>
        </div>
        <form id="weightForm">
            <div class="form-group">
                <label for="weightDate">Date</label>
                <input type="date" id="weightDate" name="date" value="{{ today }}" required>
            </div>
            <div class="form-group">
                <label for="weightValue">Weight (lbs)</label>
                <input type="number" id="weightValue" name="weight_lbs" step="0.1" min="50" max="500" required>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
</div>

<!-- Sleep Modal -->
<div class="modal" id="sleepModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Sleep</h3>
            <button class="modal-close" onclick="closeModal('sleepModal')">&times;</button>
        </div>
        <form id="sleepForm">
            <div class="form-group">
                <label for="sleepDate">Date</label>
                <input type="date" id="sleepDate" name="date" value="{{ today }}" required>
            </div>
            <div class="form-group">
                <label for="sleepHours">Hours Slept</label>
                <input type="number" id="sleepHours" name="hours" step="0.5" min="0" max="24" required>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
</div>

<!-- Wake Time Modal -->
<div class="modal" id="wakeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Wake Time</h3>
            <button class="modal-close" onclick="closeModal('wakeModal')">&times;</button>
        </div>
        <form id="wakeForm">
            <div class="form-group">
                <label for="wakeDate">Date</label>
                <input type="date" id="wakeDate" name="date" value="{{ today }}" required>
            </div>
            <div class="form-group">
                <label for="wakeTime">Wake Time</label>
                <input type="time" id="wakeTime" name="wake_time" step="1" required>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
</div>

<!-- Workout Modal -->
<div class="modal" id="workoutModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Workout</h3>
            <button class="modal-close" onclick="closeModal('workoutModal')">&times;</button>
        </div>
        <form id="workoutForm">
            <div class="form-group">
                <label for="workoutDate">Date</label>
                <input type="date" id="workoutDate" name="date" value="{{ today }}" required>
            </div>
            <div class="form-group">
                <label for="workoutType">Workout Type</label>
                <input type="text" id="workoutType" name="workout_type" placeholder="e.g., Running, Weights, Yoga" required>
            </div>
            <div class="form-group">
                <label for="workoutDuration">Duration (minutes, optional)</label>
                <input type="number" id="workoutDuration" name="duration_minutes" min="1" max="600">
            </div>
            <div class="form-group">
                <label for="workoutNotes">Notes (optional)</label>
                <textarea id="workoutNotes" name="notes" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
</div>

<!-- Calorie Entry Modal -->
<div class="modal" id="calorieModal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3>Add Food</h3>
            <button class="modal-close" onclick="closeModal('calorieModal')">&times;</button>
        </div>
        
        <!-- Food Search -->
        <div class="form-group">
            <label for="foodSearch">Search Foods</label>
            <input type="text" id="foodSearch" placeholder="Type to search foods..." autocomplete="off">
            <div id="foodSearchResults" class="search-results"></div>
        </div>
        
        <form id="calorieForm">
            <input type="hidden" id="calorieDate" name="date" value="{{ today }}">
            
            <div class="form-group">
                <label for="calorieMealName">Food / Meal Name</label>
                <input type="text" id="calorieMealName" name="meal_name" required>
            </div>
            
            <div class="form-group">
                <label for="calorieQuantity">Quantity (e.g., 150g, 2 cups)</label>
                <div class="form-group-with-btn">
                    <input type="text" id="calorieQuantity" name="quantity" placeholder="100g">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="computeCalories()">Compute</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="calorieAmount">Calories</label>
                <input type="number" id="calorieAmount" name="calories" min="0" max="5000">
                <small class="form-hint">Leave blank to auto-compute from quantity</small>
            </div>
            <input type="hidden" id="calorieFoodId" name="food_id">
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="saveAsPreset()">Save as Preset</button>
                <button type="submit" class="btn btn-primary">Log Food</button>
            </div>
        </form>
    </div>
</div>

<!-- Preset Management Modal -->
<div class="modal" id="presetModal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3>Meal Presets</h3>
            <button class="modal-close" onclick="closeModal('presetModal')">&times;</button>
        </div>
        
        <div class="preset-modal-search">
            <input type="text" id="presetModalSearchInput" placeholder="Search presets..." autocomplete="off">
        </div>
        
        <div class="preset-list" id="presetList">
            {% for preset in presets %}
            <div class="preset-item" data-id="{{ preset.id }}" data-name="{{ preset.name|lower }}" data-category="{{ (preset.category or '')|lower }}">
                <div class="preset-info">
                    <span class="preset-name">{{ preset.name }}</span>
                    <span class="preset-category">{{ preset.category or '' }}</span>
                </div>
                <div class="preset-macros">
                    <span>{{ preset.calories|int }} kcal</span>
                    {% if preset.quantity %}<span>{{ preset.quantity }}</span>{% endif %}
                </div>
                <div class="preset-actions">
                    <button class="btn btn-primary btn-sm" onclick="logPreset({{ preset.id }})">Log</button>
                    <button class="btn-icon" onclick="deletePreset({{ preset.id }})" title="Delete">√ó</button>
                </div>
            </div>
            {% else %}
            <p class="empty-state">No presets yet. Add food and click "Save as Preset".</p>
            {% endfor %}
        </div>
        
        <hr>
        
        <h4>Add New Preset</h4>
        <form id="presetForm">
            <div class="form-group">
                <label for="presetName">Name</label>
                <input type="text" id="presetName" name="name" required placeholder="e.g., Morning Coffee">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="presetCalories">Calories</label>
                    <input type="number" id="presetCalories" name="calories" min="0" required>
                </div>
                <div class="form-group">
                    <label for="presetCategory">Category</label>
                    <select id="presetCategory" name="category">
                        <option value="">--</option>
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="snack">Snack</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="presetQuantity">Quantity (e.g., 150g, 2 cups)</label>
                <input type="text" id="presetQuantity" name="quantity" placeholder="100g">
            </div>
            <input type="hidden" id="presetFoodId" name="food_id">
            <button type="submit" class="btn btn-primary">Create Preset</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Render charts
    const weightData = {{ weight_chart | safe }};
    const sleepData = {{ sleep_chart | safe }};
    const wakeData = {{ wake_chart | safe }};
    const workoutData = {{ workout_chart | safe }};
    const calorieData = {{ calorie_chart | safe }};
    
    Plotly.newPlot('weightChart', weightData.data, weightData.layout, {responsive: true, displayModeBar: false});
    Plotly.newPlot('sleepChart', sleepData.data, sleepData.layout, {responsive: true, displayModeBar: false});
    Plotly.newPlot('wakeChart', wakeData.data, wakeData.layout, {responsive: true, displayModeBar: false});
    Plotly.newPlot('workoutChart', workoutData.data, workoutData.layout, {responsive: true, displayModeBar: false});
    Plotly.newPlot('calorieChart', calorieData.data, calorieData.layout, {responsive: true, displayModeBar: false});
    
    // Render custom metric charts
    {% for cm in custom_charts %}
    (function() {
        const customData = {{ cm.chart_json | safe }};
        Plotly.newPlot('custom-chart-{{ cm.id }}', customData.data, customData.layout, {responsive: true, displayModeBar: false});
    })();
    {% endfor %}
    
    // Modal functions
    function openModal(id) {
        document.getElementById(id).classList.add('show');
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }
    
    // Close modal on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show'));
        }
    });
    
    // Form submissions
    async function submitForm(url, formId, modalId) {
        const form = document.getElementById(formId);
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Convert time input to HH:MM:SS format if present
        if (data.wake_time && data.wake_time.length === 5) {
            data.wake_time = data.wake_time + ':00';
        }
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Show warnings if any
                if (result.warnings && result.warnings.length > 0) {
                    alert('Saved with warnings:\n' + result.warnings.join('\n'));
                }
                closeModal(modalId);
                location.reload();
            } else {
                alert(result.message || 'Error saving data');
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }
    
    // Food search functionality
    let searchTimeout;
    const foodSearchInput = document.getElementById('foodSearch');
    const searchResults = document.getElementById('foodSearchResults');
    
    if (foodSearchInput) {
        foodSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/foods/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.foods.length === 0) {
                        searchResults.innerHTML = '<div class="search-empty">No foods found</div>';
                    } else {
                        searchResults.innerHTML = data.foods.map(food => `
                            <div class="search-item" onclick="selectFood(${JSON.stringify(food).replace(/"/g, '&quot;')})">
                                <span class="food-name">${food.name}</span>
                                <span class="food-cals">${Math.round(food.calories)} kcal</span>
                            </div>
                        `).join('');
                    }
                    searchResults.style.display = 'block';
                } catch (err) {
                    console.error('Search error:', err);
                }
            }, 300);
        });
        
        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!foodSearchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
    }
    
    function selectFood(food) {
        document.getElementById('calorieMealName').value = food.name;
        document.getElementById('calorieFoodId').value = food.id;
        // Set default quantity based on food's serving
        const qty = food.serving_size + (food.serving_unit || 'g');
        document.getElementById('calorieQuantity').value = qty;
        document.getElementById('calorieAmount').value = Math.round(food.calories);
        
        document.getElementById('foodSearch').value = '';
        document.getElementById('foodSearchResults').style.display = 'none';
    }
    
    async function computeCalories() {
        const foodId = document.getElementById('calorieFoodId').value;
        const quantity = document.getElementById('calorieQuantity').value;
        
        if (!foodId) {
            alert('Please select a food first by searching above');
            return;
        }
        if (!quantity) {
            alert('Please enter a quantity (e.g., 150g, 2 cups)');
            return;
        }
        
        try {
            const response = await fetch('/api/foods/compute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({food_id: parseInt(foodId), quantity: quantity})
            });
            const result = await response.json();
            
            if (result.status === 'ok') {
                document.getElementById('calorieAmount').value = result.calories;
            } else {
                alert('Error: ' + result.message);
            }
        } catch (err) {
            alert('Error computing calories: ' + err.message);
        }
    }
    
    // Calorie entry functions
    async function deleteCalorieEntry(id) {
        if (!confirm('Delete this entry?')) return;
        
        try {
            const response = await fetch(`/api/calories/${id}`, {method: 'DELETE'});
            if (response.ok) {
                location.reload();
            }
        } catch (err) {
            alert('Error deleting entry');
        }
    }
    
    // Preset functions
    async function logPreset(presetId) {
        try {
            const response = await fetch(`/api/presets/${presetId}/log`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({date: '{{ today }}'})
            });
            if (response.ok) {
                location.reload();
            }
        } catch (err) {
            alert('Error logging preset');
        }
    }
    
    async function deletePreset(id) {
        if (!confirm('Delete this preset?')) return;
        
        try {
            const response = await fetch(`/api/presets/${id}`, {method: 'DELETE'});
            if (response.ok) {
                location.reload();
            }
        } catch (err) {
            alert('Error deleting preset');
        }
    }
    
    function saveAsPreset() {
        const name = document.getElementById('calorieMealName').value;
        const calories = document.getElementById('calorieAmount').value;
        
        if (!name || !calories) {
            alert('Please fill in at least the name and calories');
            return;
        }
        
        document.getElementById('presetName').value = name;
        document.getElementById('presetCalories').value = calories;
        document.getElementById('presetQuantity').value = document.getElementById('calorieQuantity').value || '';
        document.getElementById('presetFoodId').value = document.getElementById('calorieFoodId').value || '';
        
        closeModal('calorieModal');
        openModal('presetModal');
    }
    
    // Form event listeners
    document.getElementById('weightForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('/api/weight', 'weightForm', 'weightModal');
    });
    
    document.getElementById('sleepForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('/api/sleep', 'sleepForm', 'sleepModal');
    });
    
    document.getElementById('wakeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('/api/wake', 'wakeForm', 'wakeModal');
    });
    
    document.getElementById('workoutForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('/api/workout', 'workoutForm', 'workoutModal');
    });
    
    document.getElementById('calorieForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const mealName = document.getElementById('calorieMealName').value;
        const foodId = document.getElementById('calorieFoodId').value;
        const quantity = document.getElementById('calorieQuantity').value;
        let calories = document.getElementById('calorieAmount').value;
        const date = document.getElementById('calorieDate').value;
        
        // If no calories entered but we have food_id and quantity, compute calories
        if (!calories && foodId && quantity) {
            try {
                const response = await fetch('/api/foods/compute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({food_id: parseInt(foodId), quantity: quantity})
                });
                const result = await response.json();
                
                if (result.status === 'ok') {
                    calories = result.calories;
                    document.getElementById('calorieAmount').value = calories;
                } else {
                    alert('Error computing calories: ' + result.message);
                    return;
                }
            } catch (err) {
                alert('Error computing calories: ' + err.message);
                return;
            }
        }
        
        if (!calories) {
            alert('Please enter calories or select a food with quantity to compute');
            return;
        }
        
        // Submit the entry
        try {
            const response = await fetch('/api/calories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    date: date,
                    meal_name: mealName,
                    calories: parseFloat(calories),
                    quantity: quantity || null,
                    food_id: foodId ? parseInt(foodId) : null
                })
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                closeModal('calorieModal');
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });
    
    document.getElementById('presetForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm('/api/presets', 'presetForm', 'presetModal');
    });
    
    // Preset Search Dropdown (Quick Add)
    const presetSearchInput = document.getElementById('presetSearchInput');
    const presetDropdown = document.getElementById('presetDropdown');
    
    if (presetSearchInput && presetDropdown) {
        presetSearchInput.addEventListener('focus', function() {
            presetDropdown.classList.add('show');
            filterPresetDropdown('');
        });
        
        presetSearchInput.addEventListener('input', function() {
            filterPresetDropdown(this.value.toLowerCase());
        });
        
        presetSearchInput.addEventListener('blur', function() {
            // Delay to allow click on dropdown item
            setTimeout(() => presetDropdown.classList.remove('show'), 200);
        });
        
        // Handle keyboard navigation
        presetSearchInput.addEventListener('keydown', function(e) {
            const items = presetDropdown.querySelectorAll('.preset-dropdown-item:not(.hidden)');
            const highlighted = presetDropdown.querySelector('.preset-dropdown-item.highlighted');
            let index = Array.from(items).indexOf(highlighted);
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (index < items.length - 1) index++;
                else index = 0;
                items.forEach(i => i.classList.remove('highlighted'));
                if (items[index]) items[index].classList.add('highlighted');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (index > 0) index--;
                else index = items.length - 1;
                items.forEach(i => i.classList.remove('highlighted'));
                if (items[index]) items[index].classList.add('highlighted');
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlighted) {
                    logPreset(highlighted.dataset.id);
                } else if (items.length === 1) {
                    logPreset(items[0].dataset.id);
                }
            } else if (e.key === 'Escape') {
                presetDropdown.classList.remove('show');
                presetSearchInput.blur();
            }
        });
        
        // Click on dropdown item
        presetDropdown.querySelectorAll('.preset-dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                logPreset(this.dataset.id);
            });
        });
    }
    
    function filterPresetDropdown(query) {
        const items = presetDropdown.querySelectorAll('.preset-dropdown-item');
        items.forEach(item => {
            const name = item.dataset.name || '';
            const category = item.dataset.category || '';
            if (query === '' || name.includes(query) || category.includes(query)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
            item.classList.remove('highlighted');
        });
        // Highlight first visible item
        const firstVisible = presetDropdown.querySelector('.preset-dropdown-item:not(.hidden)');
        if (firstVisible) firstVisible.classList.add('highlighted');
    }
    
    // Preset Modal Search
    const presetModalSearch = document.getElementById('presetModalSearchInput');
    const presetList = document.getElementById('presetList');
    
    if (presetModalSearch && presetList) {
        presetModalSearch.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const items = presetList.querySelectorAll('.preset-item');
            items.forEach(item => {
                const name = item.dataset.name || '';
                const category = item.dataset.category || '';
                if (query === '' || name.includes(query) || category.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Custom Metric Functions
    async function submitAddMetric(e) {
        e.preventDefault();
        const form = document.getElementById('addMetricForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/api/custom-metrics', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                closeModal('addMetricModal');
                window.location.reload();
            } else {
                alert('Error: ' + (result.message || 'Failed to create metric'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    function openAddCustomEntryModal(metricId, metricName, metricUnit) {
        document.getElementById('customEntryMetricId').value = metricId;
        document.getElementById('addCustomEntryTitle').textContent = 'Add ' + metricName + ' Entry';
        document.getElementById('customEntryUnit').textContent = metricUnit;
        document.getElementById('customEntryDate').value = '{{ today }}';
        document.getElementById('customEntryValue').value = '';
        document.getElementById('customEntryNotes').value = '';
        openModal('addCustomEntryModal');
    }
    
    async function submitAddCustomEntry(e) {
        e.preventDefault();
        const form = document.getElementById('addCustomEntryForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const metricId = data.metric_id;
        
        try {
            const response = await fetch('/api/custom-metrics/' + metricId + '/entries', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                closeModal('addCustomEntryModal');
                window.location.reload();
            } else {
                alert('Error: ' + (result.message || 'Failed to add entry'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteCustomMetric(metricId, metricName) {
        if (!confirm('Delete "' + metricName + '" and all its data? This cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/custom-metrics/' + metricId, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                window.location.reload();
            } else {
                alert('Error: ' + (result.message || 'Failed to delete metric'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    function openEditMetricModal(metricId, name, unit, color, voiceKeyword) {
        document.getElementById('editMetricId').value = metricId;
        document.getElementById('editMetricName').value = name;
        document.getElementById('editMetricUnit').value = unit;
        document.getElementById('editMetricColor').value = color || '#6366f1';
        document.getElementById('editMetricVoiceKeyword').value = voiceKeyword || '';
        openModal('editMetricModal');
    }
    
    async function submitEditMetric(e) {
        e.preventDefault();
        const metricId = document.getElementById('editMetricId').value;
        const data = {
            name: document.getElementById('editMetricName').value,
            unit: document.getElementById('editMetricUnit').value,
            color: document.getElementById('editMetricColor').value,
            voice_keyword: document.getElementById('editMetricVoiceKeyword').value || null
        };
        
        try {
            const response = await fetch('/api/custom-metrics/' + metricId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                closeModal('editMetricModal');
                window.location.reload();
            } else {
                alert('Error: ' + (result.message || 'Failed to update metric'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // --- Date & Time Display ---
    function updateDateTime() {
        const now = new Date();
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        // Day of week
        document.getElementById('dayOfWeek').textContent = days[now.getDay()];
        
        // ISO 8601 date: YYYY-MM-DD
        const isoDate = now.toISOString().split('T')[0];
        document.getElementById('dateIso').textContent = isoDate;
        
        // Time: 12-hour format with AM/PM
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const period = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12; // Convert 0 to 12 for midnight
        document.getElementById('timeClock').innerHTML = `${hours}:${minutes} <span class="time-period">${period}</span>`;
    }
    
    // Update immediately and then every minute
    updateDateTime();
    setInterval(updateDateTime, 60000);
    
    // --- Volume Control ---
    let currentVolume = 65;
    let isMuted = false;
    let volumeBeforeMute = 65;
    
    function updateVolumeUI(value, muted = false) {
        currentVolume = parseInt(value);
        isMuted = muted;
        
        document.getElementById('volumeValue').textContent = currentVolume + '%';
        
        // Update slider track fill
        const slider = document.getElementById('volumeSlider');
        slider.style.background = `linear-gradient(to right, var(--accent-blue) 0%, var(--accent-blue) ${currentVolume}%, var(--bg-secondary) ${currentVolume}%, var(--bg-secondary) 100%)`;
        slider.value = currentVolume;
        
        // Update icon based on level
        const icon = document.getElementById('volumeIcon');
        if (isMuted || currentVolume === 0) {
            icon.textContent = 'üîá';
        } else if (currentVolume < 33) {
            icon.textContent = 'üîà';
        } else if (currentVolume < 66) {
            icon.textContent = 'üîâ';
        } else {
            icon.textContent = 'üîä';
        }
        
        // Update mute button state
        const muteBtn = document.getElementById('muteBtn');
        muteBtn.classList.toggle('muted', isMuted);
    }
    
    async function updateVolume(value) {
        isMuted = false; // Unmute when adjusting volume
        updateVolumeUI(value, false);
        
        try {
            await fetch('/api/volume/set', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ volume: currentVolume })
            });
        } catch (error) {
            console.error('Volume set failed:', error);
        }
    }
    
    async function toggleMute() {
        try {
            const response = await fetch('/api/volume/toggle', { method: 'POST' });
            const result = await response.json();
            isMuted = result.muted;
            
            if (isMuted) {
                volumeBeforeMute = currentVolume;
            }
            
            // Re-fetch current state to get accurate volume
            await getVolumeState();
        } catch (error) {
            console.error('Mute toggle failed:', error);
        }
    }
    
    async function getVolumeState() {
        try {
            const response = await fetch('/api/volume/state');
            const result = await response.json();
            currentVolume = result.volume || 65;
            isMuted = result.muted || false;
            updateVolumeUI(currentVolume, isMuted);
        } catch (error) {
            console.error('Volume state check failed:', error);
        }
    }
    
    // Get initial volume state
    getVolumeState();
    
    // --- Alarm Control ---
    let alarmPlaying = false;
    
    async function loadAlarmConfig() {
        try {
            const response = await fetch('/api/alarm/config');
            const config = await response.json();
            
            document.getElementById('alarmEnabled').checked = config.enabled;
            document.getElementById('alarmTime').value = config.time;
            
            // Set day checkboxes
            const dayCheckboxes = document.querySelectorAll('#alarmDays input[type="checkbox"]');
            dayCheckboxes.forEach(cb => {
                cb.checked = config.days.includes(cb.value);
                cb.addEventListener('change', updateAlarmDays);
            });
        } catch (error) {
            console.error('Failed to load alarm config:', error);
        }
    }
    
    async function toggleAlarmEnabled() {
        const enabled = document.getElementById('alarmEnabled').checked;
        await saveAlarmConfig({ enabled });
    }
    
    async function updateAlarmTime() {
        const time = document.getElementById('alarmTime').value;
        await saveAlarmConfig({ time });
    }
    
    async function updateAlarmDays() {
        const days = [];
        document.querySelectorAll('#alarmDays input[type="checkbox"]:checked').forEach(cb => {
            days.push(cb.value);
        });
        await saveAlarmConfig({ days });
    }
    
    async function saveAlarmConfig(updates) {
        try {
            await fetch('/api/alarm/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(updates)
            });
        } catch (error) {
            console.error('Failed to save alarm config:', error);
        }
    }
    
    async function stopAlarm() {
        try {
            await fetch('/api/alarm/stop', { method: 'POST' });
            document.getElementById('alarmStopBtn').style.display = 'none';
            alarmPlaying = false;
        } catch (error) {
            console.error('Failed to stop alarm:', error);
        }
    }
    
    async function checkAlarmStatus() {
        try {
            const response = await fetch('/api/alarm/status');
            const result = await response.json();
            alarmPlaying = result.playing;
            document.getElementById('alarmStopBtn').style.display = alarmPlaying ? 'inline-block' : 'none';
        } catch (error) {
            // Ignore errors
        }
    }
    
    // Load alarm config and check status periodically
    loadAlarmConfig();
    checkAlarmStatus();
    setInterval(checkAlarmStatus, 5000);  // Check every 5 seconds
    
    // --- Clear Display Data ---
    function clearDisplayData() {
        if (!confirm('Clear all charts? (Data is NOT deleted from database)')) {
            return;
        }
        
        // Clear all Plotly charts
        const charts = ['weightChart', 'sleepChart', 'wakeChart', 'workoutChart', 'caloriesChart'];
        charts.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                Plotly.purge(el);
                el.innerHTML = '<div class="empty-chart">No data displayed</div>';
            }
        });
        
        // Clear custom metric charts
        document.querySelectorAll('[id^="customChart"]').forEach(el => {
            Plotly.purge(el);
            el.innerHTML = '<div class="empty-chart">No data displayed</div>';
        });
        
        // Clear metrics boxes
        document.querySelectorAll('.metric-value').forEach(el => {
            el.textContent = '‚Äî';
        });
    }
    
    // --- Load Sample Data ---
    async function loadSampleData() {
        if (!confirm('Load sample data? This will add demo entries to your database.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/sample-data', { method: 'POST' });
            const result = await response.json();
            
            if (result.status === 'ok') {
                alert('Sample data loaded! Refreshing...');
                window.location.reload();
            } else {
                alert('Error: ' + (result.message || 'Failed to load sample data'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // --- Auto-refresh when data is updated ---
    let lastUpdated = null;
    const AUTO_REFRESH_INTERVAL = 5000; // Check every 5 seconds
    
    async function checkForUpdates() {
        try {
            const response = await fetch('/api/last-updated');
            const data = await response.json();
            
            if (lastUpdated === null) {
                // First check - just store the value
                lastUpdated = data.last_updated;
            } else if (data.last_updated && data.last_updated !== lastUpdated) {
                // Data changed - reload the page
                console.log('Data updated, refreshing...');
                window.location.reload();
            }
        } catch (error) {
            console.log('Auto-refresh check failed:', error);
        }
    }
    
    // Start auto-refresh polling
    setInterval(checkForUpdates, AUTO_REFRESH_INTERVAL);
    // Initial check
    checkForUpdates();
</script>
{% endblock %}
